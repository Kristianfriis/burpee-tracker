<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burpee Tracker</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles override Tailwind for the calendar grid */
        .weekdays, .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-box {
            height: 50px; /* Fixed height for consistent look */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.1s;
            position: relative;
            user-select: none;
            text-align: center;
        }

        /* Styling for the completion circle */
        .completed-day {
            color: transparent; /* Hide the main day number */
            font-size: 0; /* Ensures only the content from ::after shows */
        }

        .completed-day::after {
            content: attr(data-burpees);
            width: 80%;
            height: 80%;
            border: 2px solid #10b981; /* Tailwind green-500 */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem; /* Small text for the count */
            font-weight: bold;
            color: #059669; /* Tailwind green-600 */
            background-color: #d1fae5; /* Tailwind green-100 */
        }
        
        /* Ensure the day number shows clearly inside the circle area */
        .day-box > span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
        }

        .day-box.completed-day > span {
             /* When completed, the content is handled by ::after, so day number is hidden */
            display: none; 
        }

        .day-box.current-month > span {
            color: #374151; /* gray-700 */
        }

        .day-box.not-current-month > span {
            color: #a0aec0; /* gray-400 */
        }

        .day-box.selected {
            background-color: #bfdbfe; /* blue-200 */
            border: 1px solid #60a5fa; /* blue-400 */
        }
        
        /* Modal Overlay Transition */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="max-w-md w-full bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700">Burpee Tracker ðŸ’ª</h1>
        
        <!-- Total Burpee Count Display -->
        <p id="totalBurpeesDisplay" class="text-xl font-semibold text-center text-gray-600 -mt-2">Total Burpees Logged: 0</p>

        <!-- Calendar Section -->
        <div class="calendar border border-gray-200 rounded-lg p-4">
            <div class="header flex justify-between items-center mb-4">
                <button id="prevMonth" class="text-xl font-bold p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition-colors">&lt;</button>
                <h2 id="monthYear" class="text-xl font-semibold text-gray-800"></h2>
                <button id="nextMonth" class="text-xl font-bold p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition-colors">&gt;</button>
            </div>

            <div class="weekdays text-sm font-medium text-gray-500 mb-2">
                <span>Sun</span>
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
            </div>

            <div class="days-grid" id="daysGrid">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- This area will show general messages, like PWA status or error messages -->
        <p id="messageBox" class="text-center mt-2 text-sm text-red-500 hidden"></p>

    </div>

    <!-- Modal for Logging Burpees -->
    <div id="modalOverlay" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div id="logModal" class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm border-t-8 border-indigo-500">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-gray-800">Log Activity</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-700 transition-colors text-2xl leading-none">&times;</button>
            </div>
            
            <p class="text-sm font-medium text-gray-700 mb-2">
                Selected Date: <span id="selectedDateText" class="text-indigo-600 font-bold"></span>
            </p>

            <div class="flex flex-col space-y-4">
                <input type="number" id="burpeeCount" placeholder="Enter burpee count (e.g., 50)" min="0" 
                       class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow text-center text-lg">
                
                <p id="todayCount" class="text-center text-sm font-medium text-gray-600">
                    Current Count: 0 burpees
                </p>

                <button id="logBurpees" 
                        class="p-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105">
                    Save Burpees
                </button>
            </div>
        </div>
    </div>

    <script>
        const daysGrid = document.getElementById('daysGrid');
        const monthYearText = document.getElementById('monthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const totalBurpeesDisplay = document.getElementById('totalBurpeesDisplay');
        const messageBox = document.getElementById('messageBox');

        // Modal Elements
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const logBurpeesBtn = document.getElementById('logBurpees');
        const burpeeCountInput = document.getElementById('burpeeCount');
        const selectedDateText = document.getElementById('selectedDateText');
        const todayCountP = document.getElementById('todayCount');

        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let selectedDay = currentDate.getDate();
        
        // --- Modal Control Functions ---
        function openModal() {
            modalOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent body scroll when modal is open
        }

        function closeModal() {
            modalOverlay.classList.add('hidden');
            document.body.style.overflow = '';
            burpeeCountInput.value = ''; // Clear input on close
        }

        // --- Local Storage Functions ---

        const STORAGE_KEY = 'burpeeTrackerData';

        function getBurpeeData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                return {};
            }
        }

        function calculateTotalBurpees() {
            const data = getBurpeeData();
            let total = 0;
            for (const date in data) {
                const count = parseInt(data[date]);
                if (!isNaN(count)) {
                    total += count;
                }
            }
            return total;
        }

        function updateTotalBurpeesDisplay() {
            const total = calculateTotalBurpees();
            totalBurpeesDisplay.textContent = `Total Burpees Logged: ${total}`;
        }

        function saveBurpeeCount(dateString, count) {
            try {
                const data = getBurpeeData();
                data[dateString] = count;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                showMessage(`Logged ${count} burpees for ${selectedDateText.textContent}`, 'text-green-500');
                updateTotalBurpeesDisplay(); 
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showMessage("Could not save data. Local storage might be full.", 'text-red-500');
            }
        }
        
        function showMessage(text, colorClass) {
            // Use the main message box in the body for persistent messages
            messageBox.textContent = text;
            messageBox.className = `text-center mt-2 text-sm ${colorClass}`;
            setTimeout(() => {
                messageBox.className = 'text-center mt-2 text-sm hidden';
            }, 3000);
        }

        // --- Calendar Rendering and Logic ---

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function renderCalendar() {
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();

            const firstDayIndex = firstDayOfMonth.getDay(); 
            const daysFromPrevMonth = firstDayIndex; 
            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();

            daysGrid.innerHTML = ''; 

            const burpeeData = getBurpeeData();

            // 1. Fill in the leading days from the previous month
            for (let i = daysFromPrevMonth; i > 0; i--) {
                const dayBox = createDayBox(prevMonthLastDay - i + 1, false, null, 0, false);
                daysGrid.appendChild(dayBox);
            }

            // 2. Fill in the days of the current month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateString = formatDate(date);
                const burpees = burpeeData[dateString] || 0;
                const isSelected = day === selectedDay;

                const dayBox = createDayBox(day, true, dateString, burpees, isSelected);

                dayBox.setAttribute('data-date', dateString);
                dayBox.addEventListener('click', () => selectDay(day));
                daysGrid.appendChild(dayBox);
            }

            // 3. Update the header and form date
            monthYearText.textContent = firstDayOfMonth.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });
            
            if (selectedDay > daysInMonth) {
                selectedDay = daysInMonth;
            }
            
            updateTotalBurpeesDisplay();
        }

        function createDayBox(dayNumber, isCurrentMonth, dateString, burpees = 0, isSelected = false) {
            const dayBox = document.createElement('div');
            dayBox.classList.add('day-box', 'rounded-lg');
            
            const daySpan = document.createElement('span');
            daySpan.textContent = dayNumber;
            dayBox.appendChild(daySpan);

            if (isCurrentMonth) {
                dayBox.classList.add('current-month', 'hover:bg-gray-100');
                if (isSelected) {
                    // Only apply 'selected' class if it's the currently selected day
                    const selectedDate = new Date(currentYear, currentMonth, dayNumber);
                    const currentDateMatch = new Date(currentYear, currentMonth, selectedDay);
                    if (selectedDate.getTime() === currentDateMatch.getTime()) {
                        dayBox.classList.add('selected');
                    }
                }
                
                if (burpees > 0) {
                    dayBox.classList.add('completed-day');
                    dayBox.setAttribute('data-burpees', burpees); 
                }
            } else {
                dayBox.classList.add('not-current-month');
            }

            return dayBox;
        }

        /**
         * Handles the selection of a new day and opens the modal.
         */
        function selectDay(day) {
            selectedDay = day;
            renderCalendar(); // Re-render to update the 'selected' class on the calendar
            updateFormForSelectedDay(); // Populate modal fields
            openModal(); // Show the modal
        }

        /**
         * Updates the modal input form based on the currently selected day.
         */
        function updateFormForSelectedDay() {
            const selectedDate = new Date(currentYear, currentMonth, selectedDay);
            const dateString = formatDate(selectedDate);
            
            // Update the header text in the modal
            selectedDateText.textContent = selectedDate.toLocaleDateString('en-US', {
                weekday: 'short', 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric'
            });

            // Load burpee count for the selected day
            const burpeeData = getBurpeeData();
            const count = burpeeData[dateString] || 0;
            todayCountP.textContent = `Current Count: ${count} burpees`;
            burpeeCountInput.value = count > 0 ? count : ''; // Prefill input
        }


        // --- Event Listeners ---

        // Navigation
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        // Log button in the Modal
        logBurpeesBtn.addEventListener('click', () => {
            const count = parseInt(burpeeCountInput.value);

            if (!isNaN(count) && count >= 0) {
                const selectedDate = new Date(currentYear, currentMonth, selectedDay);
                const dateString = formatDate(selectedDate);
                
                saveBurpeeCount(dateString, count);
                renderCalendar(); 
                closeModal(); // Crucial: Close modal after logging
            } else {
                // Use the main message box for errors (modal is about to close)
                showMessage('Please enter a valid number (0 or greater).', 'text-red-500');
            }
        });

        // Modal Close listeners
        closeModalBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            // Close if backdrop is clicked, but not the modal content itself
            if (e.target.id === 'modalOverlay') {
                closeModal();
            }
        });


        // --- Initialisation ---
        
        const today = new Date();
        if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
            selectedDay = today.getDate();
        } else {
            selectedDay = 1;
        }

        renderCalendar();

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((reg) => {
                        console.log('Service Worker registered successfully: ', reg);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>

